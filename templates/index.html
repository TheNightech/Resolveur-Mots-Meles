<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traitement d'Image Automatis√©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <h1>üöÄ Pr√©paration et Lancement du Traitement</h1>
    
    {% if not status_check and not output_file_exists %}
        <p>Veuillez s√©lectionner les deux fichiers image pour le traitement.</p>

        <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
            <label for="file_grille">Fichier pour la grille de mots m√©l√©s:</label>
            <input type="file" id="file_grille" name="file_grille" accept="image/*" required>
            
            <label for="file_mots">Fichier pour la liste de mots √† trouver:</label>
            <input type="file" id="file_mots" name="file_mots" accept="image/*" required>
            
            <button type="submit" id="submitBtn">R√©soudre la grille</button>
        </form>
    {% endif %}

    {% if message %}
        <div class="message {{ 'success' if 'succ√®s' in message or 'lanc√©' in message or 'R√©initialis√©' in message else 'error' }}">
            {{ message }}
        </div>
    {% endif %}

    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <p>Traitement en cours... Cela peut prendre quelque temps.</p>
    </div>
    
    <div id="status_message" class="message hidden"></div>
    <p id="progress_info"></p>
    
    <img id="grid_output" 
         style="max-width: 100%; display: none; border: 3px solid #007bff; margin-top: 20px;" 
         src="{{ url_for('static', filename='output/grid_output.png') }}?t={{ now() }}" 
         alt="Image de sortie g√©n√©r√©e (grid_output.png)">
         
    <div id="error_actions" class="restart-section hidden">
        <button type="button" id="retryBtn" class="restart-btn">üîÑ R√©essayer avec les m√™mes fichiers</button>
        <a href="{{ url_for('restart') }}" class="button-link">
            <button type="button" class="restart-btn error-btn">üóëÔ∏è R√©initialiser et recommencer</button>
        </a>
    </div>

    {% if output_file_exists and not status_check %}
        <h2>‚úÖ R√©sultat Final :</h2>
        <script>document.getElementById('grid_output').style.display = 'block';</script>

        <div class="restart-section">
            <a href="{{ url_for('restart') }}">
                <button type="button" class="restart-btn">üîÑ R√©soudre une autre grille</button>
            </a>
        </div>
    {% endif %}

</div>

<script>
    const loadingDiv = document.getElementById('loading');
    const statusMsgDiv = document.getElementById('status_message');
    const progressInfo = document.getElementById('progress_info');
    const outputImg = document.getElementById('grid_output');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const errorActionsDiv = document.getElementById('error_actions');
    const retryBtn = document.getElementById('retryBtn'); 
    let refreshInterval = null;
    let lastTimestamp = 0; 

    function startPolling() {
        loadingDiv.classList.remove('hidden');
        statusMsgDiv.classList.remove('hidden');
        statusMsgDiv.textContent = "Le traitement est en cours...";
        
        refreshInterval = setInterval(checkStatus, 2000); 
    }

    async function checkStatus() {
        try {
            const response = await fetch('{{ url_for("check_status") }}');
            const data = await response.json();
            
            const finalStatus = data.final_status;
            
            // Cacher les actions d'erreur par d√©faut
            errorActionsDiv.classList.add('hidden');
            
            // Si le travail est termin√© ou a √©chou√© (bas√© sur le champ final_status)
            if (!data.en_cours && finalStatus) {
                clearInterval(refreshInterval);
                loadingDiv.classList.add('hidden');
                
                // Si succ√®s (done ou finished), recharge la page pour afficher le r√©sultat final
                if (finalStatus === 'done' || finalStatus === 'finished') {
                    // Recharge la page sans param√®tres pour que Flask affiche le r√©sultat final via Jinja
                    window.location.href = "{{ url_for('index') }}"; 
                    return; 
                } 
                
                // Si erreur, affiche le message et les boutons d'action
                if (finalStatus === 'error') {
                    statusMsgDiv.className = 'message error';
                    statusMsgDiv.textContent = "‚ùå Le programme Python a rencontr√© une erreur. Veuillez v√©rifier les logs du serveur.";
                    
                    // Affiche les actions d'erreur
                    errorActionsDiv.classList.remove('hidden');
                    retryBtn.onclick = function() {
                        // Relance l'upload (qui relancera le thread)
                        window.location.href = "{{ url_for('relaunch_processing') }}";
                    };
                }
                
                progressInfo.textContent = "";

            } else if (data.en_cours) {
                // Mise √† jour de l'√©tat en cours
                loadingDiv.classList.remove('hidden');
                statusMsgDiv.textContent = "Traitement en cours...";
                
                // Masque le formulaire pendant le traitement
                if (uploadForm) uploadForm.style.display = 'none';
                
                // LOGIQUE D'AFFICHAGE DE LA PROGRESSION
                if (data.output_exists && data.mots_trouves > 0) {
                    progressInfo.innerHTML = `
                        Quelques mots n'ont pas √©t√© trouv√©s. Voici le premier r√©sultat : ( ${data.mots_trouves}/ ${data.total_mots} )<br>
                        Le programme est en train de chercher les autres mots. 
                    `;
                } else if (data.output_exists) {
                    progressInfo.textContent = "Image g√©n√©r√©e. D√©tection des mots en cours...";
                } else {
                    progressInfo.textContent = "Recherche initiale en cours... Premi√®re image en cours de g√©n√©ration.";
                }
            }

            // Actualise l'image si elle existe ET si un nouvel horodatage est re√ßu
            if (data.output_exists) {
                outputImg.style.display = 'block';
                if (data.timestamp > lastTimestamp) {
                    outputImg.src = "{{ url_for('static', filename='output/grid_output.png') }}?t=" + data.timestamp;
                    lastTimestamp = data.timestamp;
                }
            } else {
                outputImg.style.display = 'none'; 
            }

        } catch (error) {
            clearInterval(refreshInterval);
            loadingDiv.classList.add('hidden');
            statusMsgDiv.className = 'message error';
            statusMsgDiv.textContent = `Erreur de communication avec le serveur: ${error.message}`;
            
            // Afficher uniquement l'option de r√©initialisation en cas d'erreur de communication
            errorActionsDiv.classList.remove('hidden');
            document.getElementById('retryBtn').style.display = 'none';
        }
    }
    
    // √âv√©nement de soumission du formulaire : lance l'affichage du chargement
    if (uploadForm) {
        uploadForm.addEventListener('submit', function() {
            loadingDiv.classList.remove('hidden');
            submitBtn.style.display = 'none';
        });
    }
    // D√©marrage du polling si la variable Jinja 'status_check' est vraie (envoy√©e par /upload)
    </script>
    {% if status_check %}
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                startPolling();
            });
        </script>
    {% endif %}

</script>

</body>
</html>